"""Add search results cache table

Revision ID: 29ca0abe9c64
Revises: 973f0a15e9d8
Create Date: 2026-02-02 22:35:37.897078

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '29ca0abe9c64'
down_revision = '973f0a15e9d8'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('search_results_cache',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('cache_key', sa.String(length=32), nullable=False),
    sa.Column('keywords', sa.String(length=500), nullable=False),
    sa.Column('location', sa.String(length=200), nullable=True),
    sa.Column('job_type', sa.String(length=50), nullable=True),
    sa.Column('work_mode', sa.String(length=50), nullable=True),
    sa.Column('company', sa.String(length=200), nullable=True),
    sa.Column('sources_used', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('results', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('results_count', sa.Integer(), nullable=False),
    sa.Column('scraped_count', sa.Integer(), nullable=False),
    sa.Column('deduplicated_count', sa.Integer(), nullable=False),
    sa.Column('execution_time_seconds', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('expires_at', sa.DateTime(), nullable=False),
    sa.Column('hit_count', sa.Integer(), nullable=False),
    sa.Column('is_valid', sa.Boolean(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_search_results_cache_cache_key'), 'search_results_cache', ['cache_key'], unique=True)
    op.create_index(op.f('ix_search_results_cache_created_at'), 'search_results_cache', ['created_at'], unique=False)
    op.create_index(op.f('ix_search_results_cache_expires_at'), 'search_results_cache', ['expires_at'], unique=False)
    op.create_index(op.f('ix_search_results_cache_user_id'), 'search_results_cache', ['user_id'], unique=False)
    op.drop_index('idx_user_feed_cache_expires', table_name='user_feed_cache')
    op.drop_index('idx_user_feed_cache_user_profile', table_name='user_feed_cache')
    op.drop_table('user_feed_cache')
    op.drop_index('idx_applications_applied_at', table_name='applications')
    op.drop_index('idx_applications_status', table_name='applications')
    op.drop_index('idx_applications_user', table_name='applications')
    op.drop_table('applications')
    op.drop_index('idx_user_company_watches_company', table_name='user_company_watches')
    op.drop_index('idx_user_company_watches_user', table_name='user_company_watches')
    op.drop_table('user_company_watches')
    op.drop_index('idx_custom_sources_status', table_name='custom_sources')
    op.drop_index('idx_custom_sources_user', table_name='custom_sources')
    op.drop_table('custom_sources')
    op.drop_index('idx_watched_companies_slug', table_name='watched_companies')
    op.drop_table('watched_companies')
    op.alter_column('job_offers', 'scraped_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('job_offers', 'scraped_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.create_table('watched_companies',
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), autoincrement=False, nullable=False),
    sa.Column('company_name', sa.VARCHAR(length=200), autoincrement=False, nullable=False),
    sa.Column('company_slug', sa.VARCHAR(length=200), autoincrement=False, nullable=False),
    sa.Column('linkedin_url', sa.VARCHAR(length=500), autoincrement=False, nullable=True),
    sa.Column('careers_url', sa.VARCHAR(length=500), autoincrement=False, nullable=True),
    sa.Column('indeed_url', sa.VARCHAR(length=500), autoincrement=False, nullable=True),
    sa.Column('wttj_url', sa.VARCHAR(length=500), autoincrement=False, nullable=True),
    sa.Column('last_scraped_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('scraping_frequency', sa.INTEGER(), server_default=sa.text('24'), autoincrement=False, nullable=False),
    sa.Column('total_watchers', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=False),
    sa.Column('total_offers_found', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=False),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.PrimaryKeyConstraint('id', name='watched_companies_pkey'),
    sa.UniqueConstraint('company_slug', name='watched_companies_company_slug_key'),
    postgresql_ignore_search_path=False
    )
    op.create_index('idx_watched_companies_slug', 'watched_companies', ['company_slug'], unique=False)
    op.create_table('custom_sources',
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('url', sa.VARCHAR(length=500), autoincrement=False, nullable=False),
    sa.Column('platform', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('status', sa.VARCHAR(length=20), server_default=sa.text("'pending'::character varying"), autoincrement=False, nullable=False),
    sa.Column('last_scraped_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('offers_found', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=False),
    sa.Column('error_message', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='custom_sources_user_id_fkey', ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name='custom_sources_pkey')
    )
    op.create_index('idx_custom_sources_user', 'custom_sources', ['user_id'], unique=False)
    op.create_index('idx_custom_sources_status', 'custom_sources', ['status'], unique=False)
    op.create_table('user_company_watches',
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('watched_company_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('alert_threshold', sa.INTEGER(), server_default=sa.text('70'), autoincrement=False, nullable=False),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.Column('profile_id', sa.UUID(), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['profile_id'], ['profiles.id'], name='user_company_watches_profile_id_fkey', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='user_company_watches_user_id_fkey', ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['watched_company_id'], ['watched_companies.id'], name='user_company_watches_watched_company_id_fkey', ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name='user_company_watches_pkey'),
    sa.UniqueConstraint('user_id', 'watched_company_id', name='uq_user_company_watch')
    )
    op.create_index('idx_user_company_watches_user', 'user_company_watches', ['user_id'], unique=False)
    op.create_index('idx_user_company_watches_company', 'user_company_watches', ['watched_company_id'], unique=False)
    op.create_table('applications',
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('job_offer_id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('company_name', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('job_title', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('email_to', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('status', sa.VARCHAR(length=50), server_default=sa.text("'pending'::character varying"), autoincrement=False, nullable=False),
    sa.Column('notes', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('documents_sent', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('applied_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['job_offer_id'], ['job_offers.id'], name='applications_job_offer_id_fkey', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='applications_user_id_fkey', ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name='applications_pkey')
    )
    op.create_index('idx_applications_user', 'applications', ['user_id'], unique=False)
    op.create_index('idx_applications_status', 'applications', ['status'], unique=False)
    op.create_index('idx_applications_applied_at', 'applications', ['applied_at'], unique=False)
    op.create_table('user_feed_cache',
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('profile_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('job_offer_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('compatibility_score', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=False),
    sa.Column('calculated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.Column('expires_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['job_offer_id'], ['job_offers.id'], name='user_feed_cache_job_offer_id_fkey', ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['profile_id'], ['profiles.id'], name='user_feed_cache_profile_id_fkey', ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='user_feed_cache_user_id_fkey', ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name='user_feed_cache_pkey'),
    sa.UniqueConstraint('user_id', 'profile_id', 'job_offer_id', name='uq_user_profile_offer_cache')
    )
    op.create_index('idx_user_feed_cache_user_profile', 'user_feed_cache', ['user_id', 'profile_id'], unique=False)
    op.create_index('idx_user_feed_cache_expires', 'user_feed_cache', ['expires_at'], unique=False)
    op.drop_index(op.f('ix_search_results_cache_user_id'), table_name='search_results_cache')
    op.drop_index(op.f('ix_search_results_cache_expires_at'), table_name='search_results_cache')
    op.drop_index(op.f('ix_search_results_cache_created_at'), table_name='search_results_cache')
    op.drop_index(op.f('ix_search_results_cache_cache_key'), table_name='search_results_cache')
    op.drop_table('search_results_cache')
    # ### end Alembic commands ###
